#
# SPDX-License-Identifier: Apache-2.0
#
---
- name: Setup k8s resources for chaincode
  hosts: localhost
  vars_files:
    - ../config/ibp-vars.yml
    - ../config/ibp-org1-vars.yml
    - ../config/ibmcloud-vars.yml
  tasks:
    - name: Setup the namepsace
      community.kubernetes.k8s:
        name: "{{ namespace }}"
        api_version: v1
        kind: Namespace
        state: present

    - name: Set service name
      set_fact:
        servicename: "{{ smart_contract_name}}-srvc"

    - name: Create a Service object from an inline definition
      community.kubernetes.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            namespace: "{{ namespace }}"
            name: "{{ servicename }}"
            labels:
              app: "{{ smart_contract_name }}"
          spec:
            ports:
            - name: chaincode
              port: 9999
              targetPort: 9999
              protocol: TCP
            selector:
              app: "{{ smart_contract_name }}"
      register: srvcresult

    - name: Create connection.json
      copy:
        content: "{{ lookup('template','ibp/15-connection.json.j2') }}"
        dest: ./connection.json

    - name: Create the archive
      command: ../scripts/pkgcc.sh -l "{{ smart_contract_name}}" -t external connection.json


- name: Install and approve chaincode
  hosts: localhost
  vars: 
    smart_contract_package:  "{{ smart_contract_name}}.tgz"
  vars_files:
    - ../config/ibp-vars.yml
    - ../config/ibp-org1-vars.yml
    - ../config/ibmcloud-vars.yml
  tasks:
    - name: Install the chaincode on the peer
      ibm.blockchain_platform.installed_chaincode:
        api_endpoint: "{{ api_endpoint }}"
        api_authtype: "{{ api_authtype }}"
        api_key: "{{ api_key }}"
        api_secret: "{{ api_secret | default(omit) }}"
        api_token_endpoint: "{{ api_token_endpoint | default(omit) }}"
        peer: "{{ org1_peer_name }}"
        identity: "../_cfg/{{ org1_name }} Admin.json"
        msp_id: "{{ org1_msp_id }}"
        path: "{{ smart_contract_package }}"
      register: installcc_result

    - name: Approve the chaincode on the channel
      ibm.blockchain_platform.approved_chaincode:
        api_endpoint: "{{ api_endpoint }}"
        api_authtype: "{{ api_authtype }}"
        api_key: "{{ api_key }}"
        api_secret: "{{ api_secret | default(omit) }}"
        api_token_endpoint: "{{ api_token_endpoint | default(omit) }}"
        peer: "{{ org1_peer_name }}"
        identity: "../_cfg/{{ org1_name }} Admin.json"
        msp_id: "{{ org1_msp_id }}"
        channel: "{{ channel_name }}"
        name: "{{ smart_contract_name }}"
        version: "{{ smart_contract_version }}"
        package_id: "{{ installcc_result.installed_chaincode.package_id }}"
        sequence: "{{ smart_contract_sequence }}"
        endorsement_policy: "{{ smart_contract_endorsement_policy | default(omit) }}"
        collections_config: "{{ smart_contract_collections_file | default(omit) }}"

    - name: Commit the chaincode on the channel
      ibm.blockchain_platform.committed_chaincode:
        api_endpoint: "{{ api_endpoint }}"
        api_authtype: "{{ api_authtype }}"
        api_key: "{{ api_key }}"
        api_secret: "{{ api_secret | default(omit) }}"
        api_token_endpoint: "{{ api_token_endpoint | default(omit) }}"
        peer: "{{ org1_peer_name }}"
        identity: "../_cfg/{{ org1_name }} Admin.json"
        msp_id: "{{ org1_msp_id }}"
        channel: "{{ channel_name }}"
        organizations:
          - "{{ org1_name }}"
        name: "{{ smart_contract_name }}"
        version: "{{ smart_contract_version }}"
        sequence: "{{ smart_contract_sequence }}"
        endorsement_policy: "{{ smart_contract_endorsement_policy | default(omit) }}"
        collections_config: "{{ smart_contract_collections_file | default(omit) }}"      
    
    - name: Create a ConfigMap for the chaincode configuration
      community.kubernetes.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "{{ smart_contract_name }}.v5.conf"
            namespace: "{{ namespace }}"
            labels:
              app:  "{{ smart_contract_name }}"
          data:
            CHAINCODE_SERVER_ADDRESS: 0.0.0.0:9999
            CHAINCODE_ID: "{{ installcc_result.installed_chaincode.package_id }}"

    - name: Create a Deployment for the chaincode configuration
      community.kubernetes.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            namespace: "{{ namespace }}"
            name:  "{{ smart_contract_name }}-dpmnt"
            labels:
              app:  "{{ smart_contract_name }}"
          spec:
            replicas: 1
            selector:
              matchLabels:
                app:  "{{ smart_contract_name }}"
            template:
              metadata:
                labels:
                  app:  "{{ smart_contract_name }}"
              spec:
                containers:
                  - name: "{{ smart_contract_name }}-cc"
                    image: "{{ chaincode_docker_image }}"
                    resources:
                      requests:
                        memory: "50Mi"
                        cpu: "0.1"
                    ports:
                    - containerPort: 9999
                    envFrom:
                      - configMapRef:
                          name: "{{ smart_contract_name }}.v5.conf"
                imagePullSecrets:
                  - name: pullimg-secret-cli
